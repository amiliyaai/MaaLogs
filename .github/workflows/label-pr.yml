name: Add PR Labels

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = new Set(pr.labels.map(l => l.name));
            
            // 获取 PR 的 commits
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            // 分析 commits 类型
            const types = new Set(commits.map(c => {
              const match = c.commit.message.match(/^(\w+)/);
              return match ? match[1] : null;
            }).filter(Boolean));
            
            // 添加 label
            if (types.has('feat')) labels.add('feat');
            if (types.has('fix')) labels.add('fix');
            if (types.has('docs')) labels.add('docs');
            if (types.has('chore')) labels.add('chore');
            
            // 合并后标记为已发布
            if (pr.merged_at) labels.add('released');
            
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: Array.from(labels)
            });

name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      run-id:
        description: "Build run ID"
        required: true

permissions:
  contents: write
  actions: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: assets
          pattern: 'bundle-*'
          run-id: ${{ github.event.inputs.run-id || github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find assets -type f \( -name "*.dmg" -o -name "*.app.tar.gz*" -o -name "*.exe" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.deb" -o -name "latest.json" \) -exec cp {} release-files/ \;

      - uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

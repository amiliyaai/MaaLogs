name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      run-id:
        description: "Build run ID"
        required: true
      tag:
        description: "Tag name (e.g. v1.0.0)"
        required: true

permissions:
  contents: write
  actions: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: assets
          pattern: 'bundle-*'
          run-id: ${{ github.event.inputs.run-id || github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find assets -type f \( -name "*.dmg" -o -name "*.app.tar.gz*" -o -name "*.exe" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.deb" -o -name "latest.json" \) -exec cp {} release-files/ \;

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="${{ github.event.inputs.tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Install git-cliff
        run: |
          curl -sL https://github.com/orhun/git-cliff/releases/latest/download/git-cliff-2.12.0-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo mv git-cliff-2.12.0/git-cliff /usr/local/bin/

      - name: Generate changelog
        id: changelog
        run: |
          changelog="$(git-cliff -c .github/cliff.toml --latest --strip header)"
          {
            echo "content<<EOF"
            echo "$changelog"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: release-files/*
          body: ${{ steps.changelog.outputs.content }}
          prerelease: ${{ contains(steps.tag.outputs.tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
